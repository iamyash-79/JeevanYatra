<link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}?v=2">
<!-- ‚úÖ Desktop Topbar (Transparent & Slimmer) -->
<header class="bg-blue-950 shadow-sm relative z-50 md:block hidden">
  <div class="container mx-auto px-4 flex justify-between items-center text-sm text-white font-semibold" style="height: 24px; line-height: 24px; padding-top: 2px; padding-bottom: 2px;">
    <div class="flex space-x-4">
      <div></i>Welcome</div>
    </div>

    <div class="flex items-center gap-2 text-xs font-semibold text-white">
  <a href="{{ '/' if user else '/owner_login' }}" class="hover:text-indigo-300 flex items-center gap-1">
    <i class="fas fa-user-tie"></i> Agent
  </a>
  <span>|</span>
  <a href="{{ '/' if user else '/owner_login' }}" class="hover:text-indigo-300 flex items-center gap-1">
    <i class="fas fa-building"></i> Agency
  </a>
  <span>|</span>
  <a href="{{ '/partner' }}" target="_blank" rel="noopener noreferrer" 
   class="hover:text-indigo-300 flex items-center gap-1">
    <i class="fas fa-handshake"></i> Become Partner
</a>
<nav>
  <!-- Settings ‡§∏‡•á ‡§≠‡•Ä change ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•ã -->
  <a href="#">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</a> |
  <a href="#">English</a>
</nav>
</div>
  </div>
</header>

<!-- ‚úÖ Desktop Main Header -->
<header class="bg-white bg-opacity-30 backdrop-blur-md shadow-sm py-2 relative z-50 md:block hidden">
  <div class="container mx-auto px-4 flex justify-between items-center">

    <!-- üîπ Left: Logo -->
    <a href="/" class="flex items-center">
      <img src="{{ url_for('static', filename='logo.png') }}" alt="Tours & Travels" class="logo-img">
    </a>

    <style>
      .logo-img {
        height: 50px;     
        max-height: 50px;  
        width: 70;
        object-fit: contain;
      }
    </style>

    <!-- üîπ Center: Navigation -->
    <nav class="space-x-8 flex justify-center font-medium text-gray-700">
      <a href="/" class="hover:text-indigo-600">Home</a>
      <a href="/packages" class="hover:text-indigo-600">Packages</a>
      <a href="{% if user %}/user_booking{% else %}javascript:void(0){% endif %}"
         onclick="{% if not user %}document.getElementById('loginModal').classList.remove('hidden'){% endif %}"
         class="hover:text-indigo-600">
        My Trip
      </a>
      <a href="/about_us" class="hover:text-indigo-600">About</a>
      <a href="/contact" class="hover:text-indigo-600">Contact</a>
    </nav>

    <!-- üîπ Right: Login/Profile -->
    <div class="flex items-center space-x-4">
      {% if user %}
      <div class="relative dropdown">
        <img src="{{ url_for('static', filename='images/' + (user.image if user.image else 'default_male.png')) }}"
             alt="Profile" class="w-9 h-9 rounded-full border-2 border-indigo-500 shadow cursor-pointer" id="dropdownButton">
        <div id="userDropdown" class="absolute right-0 mt-2 w-40 bg-white border rounded shadow-md hidden z-50">
          <a href="/user_account" class="block px-4 py-2 hover:bg-indigo-100">üë§ My Profile</a>
          <a href="/user_settings" class="block px-4 py-2 hover:bg-indigo-100">‚öôÔ∏è Settings</a>
          <a href="/logout" class="block px-4 py-2 text-red-600 hover:bg-red-100">üö™ Logout</a>
        </div>
      </div>
      {% else %}
      <a href="javascript:void(0)" onclick="document.getElementById('loginModal').classList.remove('hidden')" 
         class="text-indigo-600 hover:text-indigo-800 font-semibold cursor-pointer">
        Login
      </a>
      <a href="javascript:void(0)" onclick="document.getElementById('loginModal').classList.remove('hidden')" 
         class="bg-indigo-500 text-white px-5 py-2 rounded-full hover:bg-indigo-600 transition">
        Register
      </a>
      {% endif %}
    </div>
  </div>
</header>

<!-- ‚úÖ Login Modal -->
<div id="loginModal" class="fixed inset-0 bg-black bg-opacity-40 flex justify-center items-center hidden z-50">
  <div class="bg-white rounded-lg shadow-lg px-6 py-8 w-full max-w-sm relative">
    <button onclick="document.getElementById('loginModal').classList.add('hidden')"
            class="absolute top-2 right-3 text-gray-500 hover:text-red-500 text-xl font-bold">&times;</button>

    <h2 class="text-xl font-semibold text-indigo-600 mb-6 text-center">Login via OTP</h2>

    <form method="POST" onsubmit="return false;" class="space-y-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
        <input type="email" id="loginEmail" required
               class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:outline-none"/>
      </div>

      <div>
        <button type="button" id="sendOtpBtn" onclick="sendLoginOTP()"
                class="w-full bg-indigo-500 text-white font-medium px-4 py-2 rounded hover:bg-indigo-600 transition">
          Send OTP
        </button>
      </div>

      <div id="otpSection" class="hidden space-y-3">
        <label class="block text-sm font-medium text-gray-700">Enter OTP</label>
        <input type="text" id="loginOtpInput"
               class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:outline-none"
               placeholder="6-digit OTP" />
        <button type="button" onclick="verifyLoginOTP()"
                class="w-full bg-green-500 text-white font-medium px-4 py-2 rounded hover:bg-green-600 transition">
          Verify & Login
        </button>
      </div>

      <p id="otpTimer" class="text-sm text-yellow-600 hidden text-center mt-2"></p>
    </form>
  </div>
</div>

<!-- ‚úÖ Flash Messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="fixed top-16 left-0 right-0 mx-auto max-w-md px-4 z-50">
      {% for category, msg in messages %}
        <div class="mb-3 p-3 text-center text-white rounded
            {% if category == 'success' %}bg-green-500
            {% elif category == 'error' %}bg-red-500
            {% else %}bg-yellow-500{% endif %}">
          {{ msg }}
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

<!-- ‚úÖ Login Check Global -->
<script>
  const IS_LOGGED_IN = {{ 'true' if user else 'false' }};
</script>

<!-- ‚úÖ Scripts -->
<script>

  // Desktop dropdown logic
  const dropdown = document.getElementById('userDropdown');
  const button = document.getElementById('dropdownButton');
  let dropdownTimeout;

  if (button && dropdown) {
    button.addEventListener('mouseenter', () => {
      clearTimeout(dropdownTimeout);
      dropdown.classList.remove('hidden');
    });
    button.addEventListener('mouseleave', () => {
      dropdownTimeout = setTimeout(() => dropdown.classList.add('hidden'), 200);
    });
    dropdown.addEventListener('mouseenter', () => clearTimeout(dropdownTimeout));
    dropdown.addEventListener('mouseleave', () => {
      dropdownTimeout = setTimeout(() => dropdown.classList.add('hidden'), 200);
    });
  }

  // OTP logic
  let otpInterval;
  function sendLoginOTP() {
    const email = document.getElementById("loginEmail").value.trim();
    const sendBtn = document.getElementById("sendOtpBtn");
    if (!email) return alert("Please enter your email.");
    sendBtn.disabled = true;
    sendBtn.textContent = "Sending...";
    fetch("/send-user-otp", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email })
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        alert("‚úÖ OTP sent.");
        document.getElementById("otpSection").classList.remove("hidden");
        startOtpTimer();
      } else {
        alert(data.message || "Failed to send OTP.");
      }
    })
    .finally(() => {
      sendBtn.disabled = false;
      sendBtn.textContent = "Send OTP";
    });
  }

  function verifyLoginOTP() {
    const email = document.getElementById("loginEmail").value.trim();
    const otp = document.getElementById("loginOtpInput").value.trim();

    if (!otp) return alert("Please enter the OTP.");

    fetch("/verify-user-otp", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email, otp })
    })
    .then(res => res.json())
    .then(data => {
      if (data.verified) {
        alert("üéâ Login successful!");
        // ‚úÖ Close modal & reload page
        document.getElementById("loginModal").classList.add("hidden");
        location.reload();
      } else {
        alert(data.message || "Incorrect OTP.");
      }
    });
  }

  function startOtpTimer() {
    const timerEl = document.getElementById("otpTimer");
    let sec = 300;
    timerEl.classList.remove("hidden");
    clearInterval(otpInterval);
    otpInterval = setInterval(() => {
      if (sec <= 0) {
        clearInterval(otpInterval);
        timerEl.classList.add("hidden");
        return;
      }
      const m = Math.floor(sec / 60), s = sec % 60;
      timerEl.textContent = `‚è≥ OTP valid for ${m}:${s.toString().padStart(2, '0')}`;
      sec--;
    }, 1000);
  }
</script>
